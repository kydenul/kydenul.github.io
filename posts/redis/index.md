# Redis 核心精讲：从入门到性能优化


{{< admonition type=abstract title="导语" open=true >}}
在当今高并发的互联网应用中，Redis 作为内存数据库和缓存系统的标配，以其卓越的性能和灵活的数据结构赢得了开发者的青睐。本文将带你深入了解 Redis 的核心特性，从五大数据类型的实战应用到单线程架构的性能优势，全方位提升你的 Redis 开发技能。无论是构建高性能缓存系统，还是开发实时数据处理应用，这都是一份不可或缺的实战指南。
{{< /admonition >}}

<!--more-->

## I. 简介

**Redis**(Remote Dictionary Service) 全称远程字典服务，一种**NoSQL** (Not Only SQL).

Redis is an in-memory data structure store used as a database,cache, message broker, and streaming engine.

---

## II. 基本数据类型

Redis 数据库中的每个键值对（Key-Value pair）都是由对象（Object）组成，其中：

- 数据库键（**Key**）：总是一个字符串对象（String Object）
- 数据库键对应的值（**Value**）：可以是
**字符串对象（String Object）**、**列表对象（List Object）**、
**哈希对象（Hash Object）**、**集合对象（Set Object）**、
**有序集合对象（Sorted Set Object）**中的一种

### String 字符串类型

Value 可以是字符串、也可以是数字

使用场景：计数（点赞数、粉丝数）、缓存

---

### List 列表类型

在 Redis 中，可以把 List 搞成队列、栈、阻塞队列.

List 的 Key 的底层实现就是一个链表，其中链表的每一个节点都保存了一个整数值.

Redis 链表实现的特性：

- 双向：链表节点都有 `prev` 和 `next` 指针 -> 获取某个节点的前继节点和后继节点的复杂度都是`O(1)`
- 无环：链表头节点的 `prev` 指针和表尾节点的 `next` 指针都指向 `NULL`
- 表头指针 / 表尾指针：List 结构中存在 `head` 和 `tail` 指针
- 长度计数器：List 结构中存在 `len` 属性
- 多态：List 节点使用 `void*` 指针来保存节点值，并可以通过 List 结构中的
`dup`、`free`、`match`、`sane` 属性为节点值设置类型特定函数 -> List 可以存储各种不同类型的值

使用场景：列表（关注列表、粉丝列表、消息列表，...）

---

### Hash 哈希类型

本质和 String 类型没有太大区别，还是一个简单的 key-value！

hash 更加适合对象的存储，String 更适合字符串存储

使用场景：存储用户信息、商品信息

---

### Set 集合类型

Set 中的元素不能重复且无序

使用场景：共同关注、共同粉丝、公共喜好等

---

### Zset 有序集合

Redis中，zset（有序集合）是一种特殊的数据类型，既可以像普通的集合（set）一样存储多个元素，还可以给每个元素赋一个分数（score），并根据分数对元素进行排序。在 set 中，元素必须是唯一的，但分数可以重复；

特点

- 元素按照分数从小到大排序，可以通过指定范围获取分数在某个区间内的元素；
- 元素是唯一的，每个元素都有一个唯一的标识符，称为成员（member）；
- 元素的分数可以是浮点数，用于区分元素之间的顺序；分数越小的元素越靠前；
- zset 中的元素可以动态添加、删除、修改分数，可以使用类似于集合（set）的命令来操作；
- zset 支持交集、并集等操作，可以对多个 zset 进行操作，得到一个新的 zset；

使用场景：排行榜、弹幕消息等

---

## 特殊数据类型

### Geospatial 地理位置

一种数据类型，可以存储和搜索坐标信息；适用于在给定的半径或矩形范围内查找附近的点；

Redis 提供了 GEO命令，实际上基于有序集合数据类型，通过 geohash 算法将维度和经度编码到有序集合的分数中来实现 geospatial 索引；

---

### HyperLogLog

基数，不重复的元素，可以接受误差；

Redis中 HyperLogLog 是用来做基数统计的，优点是在输入元素的数量或体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。

Redis 中，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算 $2^64$ 个不同元素的基数；

HyperLogLog 只会根据输入元素来计算基数，而不会存储输入元素本身，所以不能像集合那样，返回输入的各个元素

需要有一定的容错，错误率为 0.81

---

### Bitmap

Redis 中 bitmap，基于 string 类型进行的位操作，可以把一个字符串当作一个位向量来处理，也可以对一个或多个字符串进行位运算；

---

## RDB 持久化

RDB（Redis DataBase），Redis 会单独创建一个（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程结束，然后用这个临时文件替换上次的持久化文件；
整个过程中，主进程不进行任何 IO 操作，确保了极高的性能

生成的 RDB 文件（dump.rdb，可修改）是一个未经压缩的二进制文件，通过该文件可以还原生成 RDB 文件时的数据库状态；

比 AOF 方式更高效，但 AOF 文件的更新频率更高

### 优点

- 每次修改都会进行持久化，文件完整性更好；
- 默认每秒同步一次，可能丢失一秒的数据；

### 缺点

- 相对于数据文件来说，AOF 远远大于 rdb，修复速度比 RDB 慢；
- AOF 运行效率比 RDB 慢，故默认 RDB 持久化；

### 实现步骤

1. 命令追加：append
2. 文件写入
3. 文件同步：sync

---

## III. 常见问题

### 1. Redis 为什么是单线程？

    官方表示：Redis 是基于内存操作的，CPU不是Redis的性能瓶颈，Redis的瓶颈是根据机器的内存和网络带宽，既然可以用单线程实现，就没必要使用多线程了。

    Redis 的提供数据为 100000+ (10W+) 的QPS，非常快

---

### 2. Redis 为什么单线程还这么快？

    多线程（CPU上下文切换）不一定比单线程效率高！！！Redis 是将所有的数据全部存放在内存中的，所有说单线程去操作效率就是最高的，多线程（CPU上下文切换，是一个耗时操作）；

    对于内存系统来说，如果没有上下文切换效率就是最高的！多次读写都是在一个CPU上完成的，在内存情况下就是最佳方案！

---

## IV. 使用场景

### 缓存 Cache

Redis 最常见的用途是作为缓存，用于加速应用程序的相应速度；

把频繁访问的数据放在 Redis（内存）中，可以减少对后端数据库的访问压力，例如热点数据缓存、对象缓存、全页缓存等。

---

### 分布式锁 Distributed Lock

日常开发中，使用 Redis 作为分布式锁可以协调分布式系统中的多个节点对同一个资源进行互斥访问，确保操作的原子性。

---

### 排行榜

Redis 可以用于构建排行榜，例如游戏积分实时排名、直播送礼排名等；

常使用 `Sorted Set` 实现

```Shell
ZADD GameScore 10 "player_1" # 插入分数
ZINCRBY GameScore 10 "player_1" # 增加分数
ZREVRANGE GameScore 0 9 # 获取 Top 10
```

---

### 计数器

Redis 可以用于实现计数器，例如点赞、评论、访问次数等，可以使用 `String` 实现。

```Shell

```

## V. Reference


---

> Author: [kyden](https://github.com/kydenul)  
> URL: http://kydenul.github.io/posts/redis/  

